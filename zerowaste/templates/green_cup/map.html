{% extends 'map/map_base.html' %}
{% load static%}
{% block extra_map_css %}
{% load i18n %}
<!-- import psycopg2 -->
<style>

    
.border {
    padding: 6px 8px;
    border-style: groove;
    border-radius: 5px;
    margin:20px;
}
.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}
.info h4 {
    margin: 0 0 5px;
    color: #777;
}

/* .table{
  border-collapse: collapse;
  padding: 50px;
  font-weight: bold;

  
  /* background:rgba(191, 149, 233, 0.473); */

/* } */ */
table, th, td 
    {
        border-bottom: 1px solid #ddd;
        border-collapse: collapse;
        padding: 2px 3px;
        text-align: center;
    }
    th {
        font-weight:bold;
    }

.legend {
    line-height: 18px;
    color: #555;
}
.legend i {
   
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}
.legendwet {
    line-height: 18px;
    color: #555;
}
.legendwet i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}

/* css to customize Leaflet default styles  */
.leaflet-popup-content-wrapper {
    background: rgba(0, 0, 0, 0.9);
    color: #ffffff;
}

.leaflet-popup-content{
    font-weight: bold;
}
/* css for table tbinfo*/
#tbinfo {
  font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  font-weight: bolder;
}

#tbinfo td, #tbinfo th {
  border: 3px solid #ddd;
  padding: 8px;
}

#tbinfo tr:nth-child(even){background-color: #f2f2f2;}

#tbinfo tr:hover {background-color: rgb(194, 92, 92);}

#tbinfo th {
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: left;
  background-color: #4CAF50;
  color: white;
}
#checkboxes {
  display: none;
  /* border: 1px #dadada solid; */
}

#datepick {
  display: none;
  /* border: 1px #dadada solid; */
}

#checkboxes label {
  display: block;
  text-decoration-color: blue;
  text-align: left;
  margin: 10px;
}

#checkboxes2 {
  display: none;
  /* border: 1px #dadada solid; */
}

#checkboxes2 label {
  display: block;
  text-decoration-color: blue;
  text-align: left;
  margin: 10px;
}

#checkboxes3 {
  display: none;
  /* border: 1px #dadada solid; */
}

#checkboxes3 label {
  display: block;
  background-color:white;
  text-decoration-color: blue;
  text-align: left;
  margin: 10px;
}
#checkboxes7 {
        display: none;
        /* border: 1px #dadada solid; */
}
    
#checkboxes7 label {
        display: block;
        text-align: left;
        margin: 10px;
}

#checkboxes2 {
        display: none;
        /* border: 1px #dadada solid; */
}
    
#checkboxes2 label {
        display: block;
        text-align: left;
        margin: 10px;
}

#checkboxes5 {
        display: none;
        /* border: 1px #dadada solid; */
    }
    
#checkboxes5 label {
        display: block;
        text-align: left;
        margin: 10px;
}
#checkboxes4 {
        display: none;
        /* border: 1px #dadada solid; */
}
#checkboxes8 {
        display: none;
        /* border: 1px #dadada solid; */
}

#checkboxeszone {
        display: none;
        /* border: 1px #dadada solid; */
}
#checkboxeszone label{
    display: block;
    text-align: left;
    margin: 10px;
}


#radiobutt {
    display:none;
}
#radiobutt label{
    display: block;
    text-align: left;
    margin: 20px;
}
    
#checkboxes4 label {
        display: block;
        text-align: left;
        margin: 10px;
}


/* Popup container - can be anything you want */
.popup {
  position: relative;
  display: inline-block;
  cursor: pointer;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  left: 50%;
  margin-right: -5px;
  border-width: 5px;
}

/* The actual popup */
.popup .popuptext {
  visibility: hidden;
  width: 160px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -80px;
}

/* Popup arrow */
.popup .popuptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

/* Toggle this class - hide and show the popup */
.popup .show {
  visibility: visible;
  -webkit-animation: fadeIn 1s;
  animation: fadeIn 1s;
}

/* Add animation (fade in the popup) */
@-webkit-keyframes fadeIn {
  from {opacity: 0;} 
  to {opacity: 1;}
}

@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity:1 ;}
}

.form-control {
  width: 160px;
}

.circle {
        /* background-color: red; */
        border-radius: 50%;
    }
</style>

{% endblock extra_map_css%}

{% block map_content%}
  <!-- {% block sidebar %}
  {% endblock %} -->

  
  
    <div id="side-bar" style="background-color:  rgba(255, 255, 255);">                <!-- side-bar container -->
        <div class="mobileShow">

            <div style="text-align: center">
                <button style="display: inline-block ;position: relative; background: #000; opacity: 0.60;" id="closebutton" name="closebutton" class="btn btn-secondary"><span class="fa fa-bars"></span></button>
            </div>
    
        </div>
      <div>
        <div class="text-center border">


            <form id="projectList" style="width: 100%">

                <form>
                    <div class="multiselect">
                      <div class="selectBox" onclick="showCheckboxes7()">
                          <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> {% trans "IITB CAMPUS" %}</button>
                          <div class="overSelect"></div>
                      </div>
                      <div id="checkboxes7">
                          <div class="checkbox">
                              <label><input type="checkbox" value="{zones}" id ="zone" onchange="getBoundaryru(this)"><span> {% trans "Zones" %}</span></label>
                          </div> 
                          <div class="checkbox">
                            <label><input type="checkbox" value="{buildings}" id ="buildings" onchange="getBoundaryru(this)"><span> {% trans "Buildings" %}</span></label>
                          </div>                       
                      
                      </div>
                     <br>
                     <div class="multiselect">
                        <div class="selectBox" onclick="toggleCheckboxes8()">
                          <button type="button" class="btn btn-outline-dark" style="width: 90%;font-size:12px; "> "Index"</button>
                          <div class="overSelect"></div>
                      </div>
                      <div id="checkboxes8">
                          <div class="checkbox">
                              <label><input type="checkbox" value="{tmi}" id ="tmi" onchange="getBoundaryru(this)"><span> "Total Monthly Index"</span></label>
                          </div> 
                          <div class="checkbox">
                              <label><input type="checkbox" value="{mdw}" id ="mdw" onchange="getBoundaryru(this)"><span> "Mess dry waste"</span></label>
                          </div> 
                          <div class="checkbox">
                              <label><input type="checkbox" value="{mww}" id ="mww" onchange="getBoundaryru(this)"><span> "Mess Wet waste</span></label>
                          </div> 
                          <div class="checkbox">
                              <label><input type="checkbox" value="{hdw}" id ="hdw" onchange="getBoundaryru(this)"><span> "Hostel dry waste</span></label>
                          </div> 
                          <div class="checkbox">
                              <label><input type="checkbox" value="{hww}" id ="hww" onchange="getBoundaryru(this)"><span> "Hostel wet waste"</span></label>
                          </div> 
                          <div class="checkbox">
                              <label><input type="checkbox" value="{hew}" id ="hew" onchange="getBoundaryru(this)"><span> "Hostel E waste"</span></label>
                          </div> 
                          <div class="checkbox">
                              <label><input type="checkbox" value="{elec}" id ="elec" onchange="getBoundaryru(this)"><span> {% trans "Electricity" %}</span></label>
                          </div>
                          <div class="month">
                            <label><input type="range" class="form-range" min="0" max="11" step="1" id="customRange3" default="6.0" onchange="changeMonth(this)"><span id = "month">Jul</span></label>
                          </div>                         					
                      </div>
                     <br>
                     <br>

                      <!-- <button type="button" class="btn btn-primary" id='locate'>{% trans "Your Location" %}</button> -->
                    </div>
                   
                </div> 
                      
            </form>

        
</form>
{% endblock map_content%}
{% block extra_map_javascript%}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
// *****************
        let $locate = $('#locate');
        let $body = $('body');
        let currentPos = null;
        let marker = null;
        let oldMarker = null;
        let oldLayer = null;

        // YOUR LOCATION BUTTON
        $locate.on('click', function(e) {
            if (oldMarker) {
                mymap.removeLayer(oldMarker);
                oldMarker = null;
            }
            if (oldLayer) {
                mymap.removeLayer(oldLayer);
                oldLayer = null;
                facilityLayer = new L.featureGroup();
            }
            // $status.html('finding your location');
            if (!navigator.geolocation) {
                alert("<p>Sorry, your browser does not support Geolocation</p>");
                return;
            }
            $body.removeClass('loaded');
            navigator.geolocation.getCurrentPosition(success, error);
        });

         // IF LOCATION FETCH BY BROWSER SUCCESS
         function success(position) {
            $body.addClass('loaded');
            currentPos = [position.coords.latitude, position.coords.longitude];
            mymap.setView(currentPos, 13);
            marker = L.marker(currentPos)
                .addTo(mymap)
                .bindTooltip("Your Location")
                .openTooltip();
            oldMarker = marker;

        };
        // IF error IN FETCHING LOCATION
        function error() {
            alert("Unable to retrieve your location");
        };

        const domain = ['https://geoserver2.communitygis.net/', 'http://localhost/'];
            var rootUrl = domain[0] + 'geoserver/geonode/ows';

            var defaultParameters = {
                service: 'WFS',
                version: '1.0.0',
                request: 'GetFeature',
                outputFormat: 'json'
            };

            var wms_legend;
            var info = L.control();
            var attribute_table = L.control({
                position: 'bottomright'
            });
            var LayerList = [];
            var tempParameter = defaultParameters;
            var newLayerList = [];
            var pointLayerList = [];

            var myWorliLayerList = [];
            var popup_layer, content;           
            let  imageloca= [];
           

                       

        // <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script>
            var expanded = false;

            function showCheckboxes7() { //zonal geometry
                var checkboxes = document.getElementById("checkboxes7");
                
                if (!expanded) {
                    checkboxes7.style.display = "block";
                    expanded = true;
                } else {

                    checkboxes7.style.display = "none";
                    expanded = false;
                }
            } 

            function toggleCheckboxes8() { //index
                var checkboxes = document.getElementById("checkboxes8");
                
                if (!expanded) {
                    checkboxes8.style.display = "block";
                    expanded = true;
                } else {

                    checkboxes8.style.display = "none";
                    expanded = false;
                }
            } 

            function changeMonth(obj) {
                var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                var month = months[obj.value];
                var elemet = document.getElementById("month");
                elemet.innerHTML = month;
            }
            
            function getBoundaryru(obj) {
                let boundary = obj.value;
                console.log(boundary)
                if ($(obj).is(":checked")) {
                    if (boundary == "{wardS}")
                        putWMSru("WARD-S:s_ward");
                   
                    else if (boundary == "{zones}")    
                        putWMSru("IITB:zone_iitb");
                    else if (boundary == "{iitbound}")    
                        putWMSru("IITB:IITB_BOUNDARY"); 
                    else if (boundary == "{buildings}")    
                        putWMSru("IITB:buildings_2oct21");   
                    

                } else {
//                    alert('in removeWM'+obj.value);
                    if (boundary == "{wardS}")
                        removeWMS("WARD-S:s_ward");
                   
                    else if (boundary == "{zones}")                        
                        removeWMS("IITB:zone_iitb");
                    else if (boundary == "{iitbound}")                        
                        removeWMS("IITB:IITB_BOUNDARY");
                    else if (boundary == "{buildings}")    
                        removeWMS("IITB:buildings_2oct21");  
                    
                    
                };


            }
            function putWMSru(layer) {
               console.log(layer)
               if (layer == "WARD-S:s_ward") {
                layer = 'WARD-S:s_ward';
                currentPos = [19.1285, 72.8866]; 
                var maximumzoom = 19;
                var opac = 0.6;
                var zoom = 13;

                } 
               else if (layer == "IITB:zone_iitb") {
                currentPos = [19.1351, 72.9014];
                var maximumzoom = 20;
                var opac = 0.7;
                var zoom = 15;
               }
               else if (layer == "IITB:IITB_BOUNDARY") {
                currentPos = [19.1312, 72.9142];
                var maximumzoom = 20;
                var opac = 0.7;
                var zoom = 14;
               }
               else if (layer == "IITB:buildings_2oct21") {
                currentPos = [19.1345, 72.9045];
                var maximumzoom = 20;
                var opac = 0.5;
                var zoom = 15;
               }
                   console.log(layer)
                var wms_layer = L.tileLayer.wms('https://geoserver2.communitygis.net/geoserver/wms', {
                    layers: layer,
                    format: 'image/png',
                    opacity:opac,
                    maxZoom:maximumzoom,

                });
                    wms_layer.addTo(mymap);
                    mymap.setView(currentPos, zoom);
                    newLayerList.push(wms_layer);
                    popup_layer="https://geoserver2.communitygis.net/geoserver/IITB/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&LAYERS=" + wms_layer.options.layers + "&QUERY_LAYERS=" + wms_layer.options.layers;  
                    console.log("popupzone",popup_layer);
                    console.log(wms_layer);
                    // mymap.removeControl(legend);
                    // addLegend(position ="bottomright", pal = pal, 
                                // values = ~Type,
                                // title = "Zone Types",
                                // opacity = 1)
                    addWMSLegend(layer);
            }
            function removeWMS(unchecked_layer) {
                newLayerList.forEach((layer, index) => {
                if (layer.options.layers === unchecked_layer) {
                    mymap.removeLayer(layer);
                    newLayerList.splice(index, 1);
                    mymap.removeControl(legend);
                    // mymap.removeControl(legend1);
                }
                });
            }
            function addWMSLegend(layer) {
                lagendGraphic = "https://geoserver2.communitygis.net/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=" + layer + "&LEGEND_OPTIONS=forceLabels:on";
                wms_legend = L.wmsLegend(lagendGraphic);
            }

            mymap.addEventListener('click', Identify);
        // function for displaying spots

            
        function Identify(e) {

            console.log("Identify",e);
            // set parameters needed for GetFeatureInfo WMS request
            var sw = mymap.options.crs.project(mymap.getBounds().getSouthWest());
            var ne = mymap.options.crs.project(mymap.getBounds().getNorthEast());
            var BBOX = sw.x + "," + sw.y + "," + ne.x + "," + ne.y;
            var WIDTH = mymap.getSize().x;
            var HEIGHT = mymap.getSize().y;

            var X = Math.trunc(mymap.layerPointToContainerPoint(e.layerPoint).x);
            var Y = Math.trunc(mymap.layerPointToContainerPoint(e.layerPoint).y);

            // compose the URL for the request
          

            var URL = popup_layer + '&BBOX=' + BBOX + '&FEATURE_COUNT=1&HEIGHT=' + HEIGHT + '&WIDTH=' + WIDTH + '&INFO_FORMAT=application%2Fjson&TILED=false&CRS=EPSG%3A3857&I=' + X + '&J=' + Y;
            // console.log(URL);
            //send GetFeatureInfo as asynchronous HTTP request using jQuery $.ajax
            $.ajax({
                url: URL,
                dataType: "json",
                type: "GET",
                success: function(data) {
                    if (data.features.length !== 0) { // at least one feature returned in response
                        var feature = data.features[0]; // first feature from response
                        console.log(feature);
                        // Set up popup for clicked feature and open it
                        var popup = new L.Popup({
                            maxWidth: 300
                        });
                        
                        if (feature.properties.Name) {
                            // console.log("I reached at");
                            content = "<table class = 'popupclass' ><tr><td><b>Buildings Info</b></td><td></td></tr>" +
                                "<tr><td><b>Building Name: </b></td><td>" + feature.properties.Name + "</td></tr>"+
                                "<tr><td><b>Description: </b></td><td>"+feature.properties.descriptio + "</td></tr></table>";

                                   
                        popup.setContent(content);
                        popup.setLatLng(e.latlng);
                        mymap.openPopup(popup);
                        }
                    }
                }
            });
        }

        var testdata = {
            max: 1000,
            data :[
            {lat: 19.136497107036817, lng: 72.91415691375734, count: 531 }, //hostel1
            {lat: 19.13712553558602, lng: 72.912654876709, count: 499 }, //hostel2
            {lat: 19.136821457554422, lng: 72.9114854335785, count: 519  }, //hostel3
            {lat: 19.13696336070552, lng: 72.9100799560547, count: 649 }, //hostel4
            {lat: 19.135260514843615, lng: 72.90964007377626, count: 527 }, //hostle5
            {lat: 19.13592949209794, lng: 72.90666818618776, count: 630 }, //hostel6
            {lat: 19.135658353916185, lng: 72.9084759950638, count: 169  },  //hoste9
            {lat: 19.129034335196486, lng: 72.91580379009248, count: 755  },  //hostel0
            {lat: 19.133191482811714, lng: 72.91197359561922, count: 516 }, //hostel11
            {lat: 19.135551925723156, lng: 72.90501058101655, count: 407 },   //hostel2
            {lat: 19.13415314881135, lng: 72.90476918220521, count: 704  },   //hostel3
            {lat: 19.134730905928553, lng: 72.90596544742586, count: 793 },  //hostel4
            {lat: 19.137916135847366, lng: 72.91399598121644, count: 555 }, //hostel15
            {lat: 19.13779450528431, lng: 72.91307330131532, count: 659 }, //hostel16 
            {lat: 19.134305190353963, lng: 72.90835261344911, count: 996 },  //hostel17
            {lat: 19.13660100063135, lng: 72.90933966636659, count: 955 }//hostel18
        ]}

        var cfg = {
        // radius should be small ONLY if scaleRadius is true (or small radius is intended)
        // if scaleRadius is false it will be the constant radius used in pixels
        "radius": 2,
        "maxOpacity": .8,
        // scales the radius based on map zoom
        "scaleRadius": true,
        // if set to false the heatmap uses the global maximum for colorization
        // if activated: uses the data maximum within the current map boundaries
        //   (there will always be a red spot with useLocalExtremas true)
        "useLocalExtrema": true,
        // which field name in your data represents the latitude - default "lat"
        latField: 'lat',
        // which field name in your data represents the longitude - default "lng"
        lngField: 'lng',
        // which field name in your data represents the data value - default "value"
        valueField: 'count'
        };


        var heatmapLayer = new HeatmapOverlay(cfg);

        //mymap.addLayer(heatmapLayer);
        var map = new L.Map('map-canvas', {
        center: new L.LatLng(25.6586, -80.3568),
        zoom: 4,
        layers: [baseLayer, heatmapLayer]
        });

        heatmapLayer.setData(testData);
            


            //Legends for bin path, spots, bubbles and zone

            
        
</script>
{% endblock extra_map_javascript %}
